const e="string",t="object";function n(t){try{return t&&typeof t===e?JSON.parse(t):t}catch(e){return t}}const o=e=>JSON.stringify(e),s=(t,...n)=>typeof t===e?t:t.reduce((e,t,o)=>e+t+(n[o]||""),"");export function css(e,...t){return{type:"style",content:()=>{const n=new CSSStyleSheet;return n.replaceSync(s(e,...t)),n}}}export const script=e=>({type:"script",content:e});const i=e=>([n,s])=>{parseInt(n,10)!=n&&("function"==typeof s?(e._re??=[],e._re.indexOf(n)<0&&(e.addEventListener(n,s),e._re.push(n))):typeof s===t&&e.state?e.state[n]=s:"value"!==n||"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName&&"SELECT"!==e.tagName?"checked"===n&&"INPUT"===e.tagName&&"checkbox"===e.type?e.checked=!0===s||"true"===s:e.setAttribute(n,typeof s===t?o(s):s):e.value=s)};export const toElem=e=>e instanceof a?e:e instanceof HTMLElement?{element:e,appendChild:t=>e.appendChild(t instanceof a?t.element:t),textContent:e.textContent,innerHTML:e.innerHTML}:3===e.nodeType?e.textContent:e;class a{element=null;state={};add(e,n=()=>[]){return Array.isArray(e)||typeof e===t?Array.isArray(e)?e.forEach(e=>this.add(e,n)):e?.raw?this.element.innerHTML=s(e,...n()):e instanceof HTMLElement?this.element.appendChild(e):e instanceof a||e?.element?this.element.appendChild(e.element):e&&typeof e===t&&Object.entries(e).forEach(i(this.element)):this.element.appendChild(document.createTextNode(e)),this}constructor(e,...t){this.element=document.createElement(e),t.length&&(this.state=t[0],t.forEach((e,n)=>this.add(e,()=>t.slice(n+1))),this.element.id||(this.element.id=`${e.toLowerCase()}-${Math.random().toString(36).substring(2,8)}`))}}export const html=new Proxy({},{get:(e,t)=>(...e)=>{if(e[0]&&Array.isArray(e[0])&&e[0].raw){const n=s(e[0],...e.slice(1));return new a(t,n)}if(t.includes("-")||customElements.get(t)){const n=document.createElement(t);return e.length>0&&e[0]&&"object"==typeof e[0]&&!Array.isArray(e[0])?(Object.entries(e[0]).forEach(([e,t])=>{"function"==typeof t?n.addEventListener(e,t):n.setAttribute(e,"object"==typeof t?o(t):t)}),e.slice(1).forEach(e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):e instanceof a?n.appendChild(e.element):e instanceof HTMLElement&&n.appendChild(e)})):e.forEach(e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):e instanceof a?n.appendChild(e.element):e instanceof HTMLElement&&n.appendChild(e)}),{element:n}}return new a(t,...e)}});export function pfusch(e,s,r){r||(r=s,s={}),s={...s};class l extends HTMLElement{static formAssociated=!0;#e;constructor(){super(),this.#e=this.attachInternals();const e=this.#e;this.scriptsExecuted=!1,this.initialized=!1,this.is={...s};for(const[e,t]of Object.entries(s)){const t=this.getAttribute(e)||this.getAttribute(e.toLowerCase());null!==t&&(this.is[e]=n(t))}this.lightDOMChildren=Array.from(this.children);this.attachShadow({mode:"open",serializable:!0}),this.state=(t=>{const n={},s=new Proxy({...this.is},{set:(s,i,a)=>(s[i]!==a&&(s[i]=a,"subscribe"!==i&&(t(),e.setFormValue(o(s))),(n[i]||[]).forEach(e=>e(a))),!0),get:(e,t)=>e[t]});return s.subscribe=(e,t)=>{(n[e]??=[]).push(t)},s})(()=>this.render()),"lazy"===this.getAttribute("as")&&this.shadowRoot.children.length>0||this.render()}static get observedAttributes(){return["id","as",...Object.entries(s).filter(([e,n])=>typeof n!==t).map(([e])=>e).flatMap(e=>[e,e.toLowerCase()])]}setElementId(e,t){e.id=t,i(e)(["id",t])}attributeChangedCallback(e,t,o){if(t===o)return;if("as"===e)return void("lazy"!==o&&"lazy"===t&&this.render());const s=Object.keys(this.is).find(t=>t===e||t.toLowerCase()===e);s&&this.state&&(this.state[s]=n(o))}triggerEvent(t,n){const s=`${e}.${t}`;this.dispatchEvent(new CustomEvent(s,{detail:n,bubbles:!0})),this.dispatchEvent(new CustomEvent(t,{detail:n,bubbles:!0})),window.postMessage({eventName:s,detail:{sourceId:this.is.id,data:o(n)}},"*")}render(){if(!r)return;const e=(e,t)=>this.triggerEvent(e,t),t=e=>e?this.lightDOMChildren.filter(t=>"string"==typeof e&&(t.tagName?.toLowerCase()===e.toLowerCase()||t.matches?.(e))):this.lightDOMChildren,n=r(this.state,e,{children:t,childElements:e=>t(e).map(e=>{return(t=e)instanceof a?t:t instanceof HTMLElement?{element:t,appendChild:e=>t.appendChild(e instanceof a?e.element:e),textContent:t.textContent,innerHTML:t.innerHTML}:3===t.nodeType?t.textContent:t;var t})});return Array.isArray(n)?this.initialized?void this.updateComponent(n):(this.initializeComponent(n,e),void(this.initialized=!0)):void 0}initializeComponent(e,t){const n=document.getElementById("pfusch-style");if(n){const e=this.createStyleSheetFromElement(n);this.shadowRoot.adoptedStyleSheets=[e]}document.querySelectorAll("link[data-pfusch]").forEach(e=>{const t=e.cloneNode(!0);this.shadowRoot.appendChild(t)}),this.renderItems(e)}updateComponent(e){let t=null;const n=this.shadowRoot.activeElement,o=document.activeElement;let s=null;if(n&&n!==this?s=n:o===this&&this.shadowRoot.activeElement&&(s=this.shadowRoot.activeElement),s){("INPUT"===s.tagName||"BUTTON"===s.tagName||"SELECT"===s.tagName||"TEXTAREA"===s.tagName||s.hasAttribute("tabindex")||"true"===s.contentEditable)&&(t={id:s.id,tagName:s.tagName,value:s.value,selectionStart:s.selectionStart,selectionEnd:s.selectionEnd,name:s.name,className:s.className,placeholder:s.placeholder,textContent:s.textContent?.trim()},console.log("Storing focus info:",t))}const i=[...this.shadowRoot.adoptedStyleSheets],a=Array.from(this.shadowRoot.querySelectorAll("link[data-pfusch]"));this.shadowRoot.innerHTML="",this.shadowRoot.adoptedStyleSheets=i,a.forEach(e=>this.shadowRoot.appendChild(e)),this.renderItems(e),t&&requestAnimationFrame(()=>{this.restoreFocus(t)})}restoreFocus(e){let t=null;if(e.id&&(t=this.shadowRoot.getElementById(e.id)),!t&&e.name&&(t=this.shadowRoot.querySelector(`${e.tagName.toLowerCase()}[name="${e.name}"]`)),!t&&e.placeholder&&(t=this.shadowRoot.querySelector(`${e.tagName.toLowerCase()}[placeholder="${e.placeholder}"]`)),!t&&e.textContent){const n=this.shadowRoot.querySelectorAll(e.tagName.toLowerCase());t=Array.from(n).find(t=>t.textContent?.trim()===e.textContent)}!t&&e.className&&(t=this.shadowRoot.querySelector(`${e.tagName.toLowerCase()}.${e.className.split(" ")[0]}`)),t?(console.log("Restoring focus to:",t),t.focus(),"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||"number"!=typeof e.selectionStart||t.value!==e.value||t.setSelectionRange(e.selectionStart,e.selectionEnd)):console.log("Could not find element to restore focus to:",e)}renderItems(e){Array.isArray(e)||(e=[e]),e.forEach(e=>{if(e)if("style"===e.type){const t=e.content();this.shadowRoot.adoptedStyleSheets=[...this.shadowRoot.adoptedStyleSheets,t]}else if("script"!==e.type||this.scriptsExecuted)e instanceof a||e?.element?this.shadowRoot.appendChild(e.element):Array.isArray(e)?this.renderItems(e):"string"==typeof e&&this.shadowRoot.appendChild(document.createTextNode(e));else{try{const t={component:this,shadowRoot:this.shadowRoot,state:this.state,addEventListener:this.addEventListener.bind(this),querySelector:e=>this.shadowRoot.querySelector(e),querySelectorAll:e=>this.shadowRoot.querySelectorAll(e)};e.content.call(t)}catch(e){console.error("Script execution error:",e)}this.scriptsExecuted=!0}})}createStyleSheetFromElement(e){const t=new CSSStyleSheet;return t.replaceSync(e.textContent||e.innerHTML),t}}return customElements.define(e,l),l}
