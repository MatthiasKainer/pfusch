const e="string",t="object",s=JSON.stringify,i=new Map,n=["checked","selected","disabled","readonly","multiple"],r=t=>{try{return t&&typeof t===e?JSON.parse(t):t}catch{return t}},o=(t,...s)=>typeof t===e?t:t.reduce((e,t,i)=>e+t+(s[i]||""),"");export const css=(e,...t)=>{const s=o(e,...t);let n;return{type:"style",content:()=>n||(n=i.get(s)||(i.set(s,n=new CSSStyleSheet),n.replaceSync(s),n))}};export const script=e=>({type:"script",content:e});export const toElem=e=>e instanceof a?e:"undefined"!=typeof HTMLElement&&e instanceof HTMLElement?{element:e}:3===e?.nodeType?e.textContent:e;class a{constructor(e,...t){this.element=document.createElement(e),this.state=t[0]||{},t.forEach((e,s)=>this.add(e,()=>t.slice(s+1)))}add(e,i=()=>[]){if(!e)return this;const n=typeof e;var r;return"string"===n?this.element.appendChild(document.createTextNode(e)):Array.isArray(e)?e.forEach(e=>this.add(e,i)):e.raw?this.element.innerHTML=o(e,...i()):e.element||e instanceof HTMLElement?this.element.appendChild(e.element||e):n===t&&Object.entries(e).forEach((r=this.element,([e,i])=>{+e!=e&&("function"==typeof i?(r._re??={},r._re[e]&&r.removeEventListener(e,r._re[e]),r.addEventListener(e,r._re[e]=i)):typeof i===t&&r.state?r.state[e]=i:e in r?r[e]=i:r.setAttribute(e,typeof i===t?s(i):i))})),this}}export const html=new Proxy({},{get:(e,i)=>(...e)=>{if("raw"===i)return e=>({element:Object.assign(document.createElement("span"),{innerHTML:e})});if(i.includes("-")||customElements.get(i)){const n=document.createElement(i),[r,...o]=e[0]&&typeof e[0]===t&&!Array.isArray(e[0])?e:[{},...e];return Object.entries(r).forEach(([e,i])=>n["function"==typeof i?"addEventListener":"setAttribute"](e,typeof i===t?s(i):i)),o.forEach(e=>n.appendChild("string"==typeof e?document.createTextNode(e):e?.element||e)),{element:n}}return new a(i,...e)}});export function pfusch(e,t,i){i||([i,t]=[t,{}]);class o extends HTMLElement{static formAssociated=!0;static observedAttributes=["id","as","inject-styles","inject-links",...Object.keys(t).flatMap(e=>[e,e.toLowerCase(),e.replace(/[A-Z]/g,"-$&").toLowerCase()])];#e;get internals(){return this.#e}constructor(){super(),this.#e=this.attachInternals(),this._f=32,this._subs={},this._ids=new Map,this.is={...t};for(const[e]of Object.entries(t)){const t=this.getAttribute(e)||this.getAttribute(e.toLowerCase())||this.getAttribute(e.replace(/[A-Z]/g,"-$&").toLowerCase());null!==t&&(this.is[e]=r(t))}this.lightDOMChildren=Array.from(this.children),this._hydrating=!0,this._lightById=new Map([...this.lightDOMChildren,...this.lightDOMChildren.flatMap(e=>Array.from(e.querySelectorAll?.("[id]")||[]))].filter(e=>e.id).map(e=>[e.id,e])),this.attachShadow({mode:"open",serializable:!0}),this.state=new Proxy({...this.is},{set:(e,t,i)=>(e[t]!==i&&(e[t]=i,"subscribe"===t||32&this._f||(this.scheduleRender(),this.#e.setFormValue(s(e))),(this._subs[t]||[]).forEach(e=>e(i))),!0),get:(e,t)=>"subscribe"===t?(t,s)=>{(this._subs[t]??=[]).push(s);try{s(e[t])}catch{}return()=>{const e=this._subs[t];e&&(this._subs[t]=e.filter(e=>e!==s))}}:e[t]})}connectedCallback(){32&this._f&&(this._f&=-33,"lazy"===this.getAttribute("as")&&this.shadowRoot.children.length||this.render())}disconnectedCallback(){this.dispatchEvent(new CustomEvent("disconnected",{bubbles:!1}))}getStableId(e,t){const s=`${e}-${t}`;return this._ids.has(s)||this._ids.set(s,`${e.toLowerCase()}-${Math.random().toString(36).substring(2,8)}`),this._ids.get(s)}attributeChangedCallback(e,t,s){if(t===s)return;if("as"===e&&"lazy"!==s&&"lazy"===t)return this.render();const i=Object.keys(this.is).find(t=>t===e||t.toLowerCase()===e||t.replace(/[A-Z]/g,"-$&").toLowerCase()===e);i&&this.state&&(this.state[i]=r(s))}render(){if(!i)return;if(8&this._f)return void(this._f|=16);this._f|=8;const t=e=>e?this.lightDOMChildren.filter(t=>t.tagName?.toLowerCase()===e.toLowerCase()||t.matches?.(e)):this.lightDOMChildren,n=i(this.state,(t,i)=>{const n=`${e}.${t}`;[n,t].forEach(e=>this.dispatchEvent(new CustomEvent(e,{detail:i,bubbles:!0,composed:!0}))),window.postMessage({eventName:n,detail:{sourceId:this.is.id,data:s(i)}},"*")},{children:t,childElements:e=>t(e).map(toElem)});if(!Array.isArray(n))return;const r=this.shadowRoot.activeElement?.id;if(!(2&this._f)){const e=[...document.querySelectorAll(this.getAttribute("inject-styles")||"style[data-pfusch]")];if(e.length){const t=new CSSStyleSheet;t.replaceSync(e.map(e=>e.textContent||e.innerHTML).join("\n")),this.shadowRoot.adoptedStyleSheets=[t,...this.shadowRoot.adoptedStyleSheets]}this._f|=2}4&this._f||(document.querySelectorAll(this.getAttribute("inject-links")||"link[data-pfusch]").forEach(e=>this.shadowRoot.appendChild(e.cloneNode(!0))),this._f|=4);const o=[];this._pos=0;const h=e=>{const t=e.id&&this._lightById?.get(e.id);if(t&&t.tagName===e.tagName){const s=new Set(Array.from(e.attributes).map(e=>e.name));Array.from(t.attributes).forEach(t=>{s.has(t.name)||e.setAttribute(t.name,t.value)}),t.classList.forEach(t=>e.classList.add(t)),(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&!e.hasAttribute("value")&&t.value&&!e.value&&(e.value=t.value)}e.querySelectorAll?.("[id]").forEach(h)},l=e=>{e.id||(e.id=this.getStableId(e.tagName,this._pos++)),h(e),o.push(e)},c=e=>{if(!e)return;const t=e?.element||((s=e)&&(s instanceof a||"undefined"!=typeof window&&window.Element&&s instanceof window.Element||1===s.nodeType)?e:null);var s;if(t)l(t);else if("string"==typeof e){const t=document.createElement("span");t.textContent=e,l(t)}};n.forEach(e=>{if(e)if("style"===e.type){const t=e.content();this.shadowRoot.adoptedStyleSheets.includes(t)||(this.shadowRoot.adoptedStyleSheets=[...this.shadowRoot.adoptedStyleSheets,t])}else if("script"!==e.type||1&this._f)Array.isArray(e)?e.forEach(c):c(e);else{try{e.content.call({component:this,shadowRoot:this.shadowRoot,state:this.state,addEventListener:this.addEventListener.bind(this),querySelector:e=>this.shadowRoot.querySelector(e),querySelectorAll:e=>this.shadowRoot.querySelectorAll(e)})}catch(e){console.error("Script error:",e)}this._f|=1}}),this.syncChildren(this.shadowRoot,o.filter(e=>"LINK"!==e.tagName)),r&&requestAnimationFrame(()=>this.shadowRoot.getElementById(r)?.focus()),this._f&=-9,this._hydrating=!1,64&this._f&&(this._f&=-65),16&this._f&&(this._f&=-17,this.render())}scheduleRender(){8&this._f?this._f|=16:64&this._f||(this._f|=64,queueMicrotask(()=>{64&this._f&&!(8&this._f)?this.render():this._f|=16}))}syncChildren(e,t){const s=Array.from(e.children).filter(e=>null===e.getAttribute("data-pfusch")),i=new Map(s.filter(e=>e.id).map(e=>[e.id,e])),r=new Set,o=(e,t)=>e.id||(e.id=this.getStableId(e.tagName,t)),a=(e,t)=>{if(!t._re&&!e._re)return;e._re??={};const s=t._re||{};for(const[t,i]of Object.entries(s))e._re[t]!==i&&(e._re[t]&&e.removeEventListener(t,e._re[t]),e.addEventListener(t,e._re[t]=i));for(const t of Object.keys(e._re))s[t]||(e.removeEventListener(t,e._re[t]),delete e._re[t])},h=(e,t)=>{const s=new Set;for(const i of t.attributes)"id"!==i.name&&(s.add(i.name),e.getAttribute(i.name)!==i.value&&e.setAttribute(i.name,i.value));for(const t of Array.from(e.attributes))"id"===t.name||s.has(t.name)||e.removeAttribute(t.name)},l=(e,t)=>{if(n.forEach(s=>{if(void 0!==t[s]&&t[s]!==e[s])try{e[s]=t[s]}catch{}}),"value"in t&&!(/^(INPUT|TEXTAREA|SELECT)$/.test(t.tagName)&&!t.hasAttribute?.("value")||document.activeElement===e||e.contains(document.activeElement))&&t.value!==e.value)try{e.value=t.value}catch{}},c=(e,t)=>{const s=Array.from(t.childNodes);if(!s.length)return void(e.firstChild&&(e.textContent=""));const i=[],n=new Map,r=new Map;for(const t of Array.from(e.childNodes))if(3===t.nodeType)i.push(t);else if(1===t.nodeType)if(t.id)n.set(t.id,t);else{const e=r.get(t.tagName)||[];e.push(t),r.set(t.tagName,e)}let a=null,h=0;const l=t=>{a?a.nextSibling!==t&&e.insertBefore(t,a.nextSibling):e.firstChild!==t&&e.insertBefore(t,e.firstChild),a=t};s.forEach(e=>{if(3===e.nodeType){const t=i.shift(),s=t||document.createTextNode(e.textContent);return t&&t.textContent!==e.textContent&&(t.textContent=e.textContent),void l(s)}if(1===e.nodeType){o(e,h++);let t=n.get(e.id);if(t)n.delete(e.id);else{const s=r.get(e.tagName);s?.length&&(t=s.shift())}l(t?d(t,e):e)}}),[i,...n.values(),...[...r.values()].flat()].flat().forEach(t=>{t?.parentNode===e&&t.remove()})},d=(e,t)=>e.tagName!==t.tagName?(e.replaceWith(t),t):([a,h,l,c].forEach(s=>s(e,t)),e),f=t.map((t,s)=>{const n=o(t,s),a=i.get(n);a&&i.delete(n);const h=a?d(a,t):e.appendChild(t);return r.add(h.id),h});s.forEach(e=>{r.has(e.id)||e.remove()});let u=null;for(const t of f)t.parentNode&&((u?u.nextElementSibling!==t:e.firstElementChild!==t)&&e.insertBefore(t,u?.nextElementSibling||e.firstElementChild),u=t)}}return customElements.define(e,o),o}
