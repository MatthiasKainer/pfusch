const t="string",e="object",s=JSON.stringify,n=new Map,i=["checked","selected","disabled","readonly","multiple"],r=e=>{try{return e&&typeof e===t?JSON.parse(e):e}catch{return e}},o=(e,...s)=>typeof e===t?e:e.reduce((t,e,n)=>t+e+(s[n]||""),"");export const css=(t,...e)=>{const s=o(t,...e);let i;return{type:"style",content:()=>i||(i=n.get(s)||(n.set(s,i=new CSSStyleSheet),i.replaceSync(s),i))}};export const script=t=>({type:"script",content:t});export const toElem=t=>t instanceof a?t:"undefined"!=typeof HTMLElement&&t instanceof HTMLElement?{element:t}:3===t?.nodeType?t.textContent:t;class a{constructor(t,...e){this.element=document.createElement(t),this.state=e[0]||{},e.forEach((t,s)=>this.add(t,()=>e.slice(s+1)))}add(t,n=()=>[]){if(!t)return this;const i=typeof t;var r;return"string"===i?this.element.appendChild(document.createTextNode(t)):Array.isArray(t)?t.forEach(t=>this.add(t,n)):t.raw?this.element.innerHTML=o(t,...n()):t.element||t instanceof HTMLElement?this.element.appendChild(t.element||t):i===e&&Object.entries(t).forEach((r=this.element,([t,n])=>{+t!=t&&("function"==typeof n?(r._re??={},r._re[t]&&r.removeEventListener(t,r._re[t]),r.addEventListener(t,r._re[t]=n)):typeof n===e&&r.state?r.state[t]=n:t in r?r[t]=n:r.setAttribute(t,typeof n===e?s(n):n))})),this}}export const html=new Proxy({},{get:(t,n)=>(...t)=>{if("raw"===n)return t=>({element:Object.assign(document.createElement("span"),{innerHTML:t})});if(n.includes("-")||customElements.get(n)){const i=document.createElement(n),[r,...o]=t[0]&&typeof t[0]===e&&!Array.isArray(t[0])?t:[{},...t];return Object.entries(r).forEach(([t,n])=>i["function"==typeof n?"addEventListener":"setAttribute"](t,typeof n===e?s(n):n)),o.forEach(t=>i.appendChild("string"==typeof t?document.createTextNode(t):t?.element||t)),{element:i}}return new a(n,...t)}});export function pfusch(t,e,n){n||([n,e]=[e,{}]);class o extends HTMLElement{static formAssociated=!0;static observedAttributes=["id","as","inject-styles","inject-links",...Object.keys(e).flatMap(t=>[t,t.toLowerCase()])];#t;get internals(){return this.#t}constructor(){super(),this.#t=this.attachInternals(),this._f=32,this._subs={},this._ids=new Map,this.is={...e};for(const[t]of Object.entries(e)){const e=this.getAttribute(t)||this.getAttribute(t.toLowerCase());null!==e&&(this.is[t]=r(e))}this.lightDOMChildren=Array.from(this.children),this._hydrating=!0,this._lightById=new Map([...this.lightDOMChildren,...this.lightDOMChildren.flatMap(t=>Array.from(t.querySelectorAll?.("[id]")||[]))].filter(t=>t.id).map(t=>[t.id,t])),this.attachShadow({mode:"open",serializable:!0}),this.state=new Proxy({...this.is},{set:(t,e,n)=>(t[e]!==n&&(t[e]=n,"subscribe"===e||32&this._f||(this.scheduleRender(),this.#t.setFormValue(s(t))),(this._subs[e]||[]).forEach(t=>t(n))),!0),get:(t,e)=>"subscribe"===e?(e,s)=>{(this._subs[e]??=[]).push(s);try{s(t[e])}catch{}return()=>{const t=this._subs[e];t&&(this._subs[e]=t.filter(t=>t!==s))}}:t[e]})}connectedCallback(){32&this._f&&(this._f&=-33,"lazy"===this.getAttribute("as")&&this.shadowRoot.children.length||this.render())}disconnectedCallback(){this.dispatchEvent(new CustomEvent("disconnected",{bubbles:!1}))}getStableId(t,e){const s=`${t}-${e}`;return this._ids.has(s)||this._ids.set(s,`${t.toLowerCase()}-${Math.random().toString(36).substring(2,8)}`),this._ids.get(s)}attributeChangedCallback(t,e,s){if(e===s)return;if("as"===t&&"lazy"!==s&&"lazy"===e)return this.render();const n=Object.keys(this.is).find(e=>e===t||e.toLowerCase()===t);n&&this.state&&(this.state[n]=r(s))}render(){if(!n)return;if(8&this._f)return void(this._f|=16);this._f|=8;const e=t=>t?this.lightDOMChildren.filter(e=>e.tagName?.toLowerCase()===t.toLowerCase()||e.matches?.(t)):this.lightDOMChildren,i=n(this.state,(e,n)=>{const i=`${t}.${e}`;[i,e].forEach(t=>this.dispatchEvent(new CustomEvent(t,{detail:n,bubbles:!0,composed:!0}))),window.postMessage({eventName:i,detail:{sourceId:this.is.id,data:s(n)}},"*")},{children:e,childElements:t=>e(t).map(toElem)});if(!Array.isArray(i))return;const r=this.shadowRoot.activeElement?.id;if(!(2&this._f)){const t=[...document.querySelectorAll(this.getAttribute("inject-styles")||"style[data-pfusch]")];if(t.length){const e=new CSSStyleSheet;e.replaceSync(t.map(t=>t.textContent||t.innerHTML).join("\n")),this.shadowRoot.adoptedStyleSheets=[e,...this.shadowRoot.adoptedStyleSheets]}this._f|=2}4&this._f||(document.querySelectorAll(this.getAttribute("inject-links")||"link[data-pfusch]").forEach(t=>this.shadowRoot.appendChild(t.cloneNode(!0))),this._f|=4);const o=[];this._pos=0;const h=t=>{const e=t.id&&this._lightById?.get(t.id);if(e&&e.tagName===t.tagName){const s=new Set(Array.from(t.attributes).map(t=>t.name));Array.from(e.attributes).forEach(e=>{s.has(e.name)||t.setAttribute(e.name,e.value)}),e.classList.forEach(e=>t.classList.add(e)),(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&!t.hasAttribute("value")&&e.value&&!t.value&&(t.value=e.value)}t.querySelectorAll?.("[id]").forEach(h)},l=t=>{t.id||(t.id=this.getStableId(t.tagName,this._pos++)),h(t),o.push(t)},c=t=>{if(!t)return;const e=t?.element||((s=t)&&(s instanceof a||"undefined"!=typeof window&&window.Element&&s instanceof window.Element||1===s.nodeType)?t:null);var s;if(e)l(e);else if("string"==typeof t){const e=document.createElement("span");e.textContent=t,l(e)}};i.forEach(t=>{if(t)if("style"===t.type){const e=t.content();this.shadowRoot.adoptedStyleSheets.includes(e)||(this.shadowRoot.adoptedStyleSheets=[...this.shadowRoot.adoptedStyleSheets,e])}else if("script"!==t.type||1&this._f)Array.isArray(t)?t.forEach(c):c(t);else{try{t.content.call({component:this,shadowRoot:this.shadowRoot,state:this.state,addEventListener:this.addEventListener.bind(this),querySelector:t=>this.shadowRoot.querySelector(t),querySelectorAll:t=>this.shadowRoot.querySelectorAll(t)})}catch(t){console.error("Script error:",t)}this._f|=1}}),this.syncChildren(this.shadowRoot,o.filter(t=>"LINK"!==t.tagName)),r&&requestAnimationFrame(()=>this.shadowRoot.getElementById(r)?.focus()),this._f&=-9,this._hydrating=!1,64&this._f&&(this._f&=-65),16&this._f&&(this._f&=-17,this.render())}scheduleRender(){8&this._f?this._f|=16:64&this._f||(this._f|=64,queueMicrotask(()=>{64&this._f&&!(8&this._f)?this.render():this._f|=16}))}syncChildren(t,e){const s=Array.from(t.children).filter(t=>null===t.getAttribute("data-pfusch")),n=new Map(s.filter(t=>t.id).map(t=>[t.id,t])),r=new Set,o=(t,e)=>t.id||(t.id=this.getStableId(t.tagName,e)),a=(t,e)=>{if(!e._re&&!t._re)return;t._re??={};const s=e._re||{};for(const[e,n]of Object.entries(s))t._re[e]!==n&&(t._re[e]&&t.removeEventListener(e,t._re[e]),t.addEventListener(e,t._re[e]=n));for(const e of Object.keys(t._re))s[e]||(t.removeEventListener(e,t._re[e]),delete t._re[e])},h=(t,e)=>{const s=new Set;for(const n of e.attributes)"id"!==n.name&&(s.add(n.name),t.getAttribute(n.name)!==n.value&&t.setAttribute(n.name,n.value));for(const e of Array.from(t.attributes))"id"===e.name||s.has(e.name)||t.removeAttribute(e.name)},l=(t,e)=>{if(i.forEach(s=>{if(void 0!==e[s]&&e[s]!==t[s])try{t[s]=e[s]}catch{}}),"value"in e&&!(/^(INPUT|TEXTAREA|SELECT)$/.test(e.tagName)&&!e.hasAttribute?.("value")||document.activeElement===t||t.contains(document.activeElement))&&e.value!==t.value)try{t.value=e.value}catch{}},c=(t,e)=>{const s=Array.from(e.childNodes);if(!s.length)return void(t.firstChild&&(t.textContent=""));const n=[],i=new Map,r=new Map;for(const e of Array.from(t.childNodes))if(3===e.nodeType)n.push(e);else if(1===e.nodeType)if(e.id)i.set(e.id,e);else{const t=r.get(e.tagName)||[];t.push(e),r.set(e.tagName,t)}let a=null,h=0;const l=e=>{a?a.nextSibling!==e&&t.insertBefore(e,a.nextSibling):t.firstChild!==e&&t.insertBefore(e,t.firstChild),a=e};s.forEach(t=>{if(3===t.nodeType){const e=n.shift(),s=e||document.createTextNode(t.textContent);return e&&e.textContent!==t.textContent&&(e.textContent=t.textContent),void l(s)}if(1===t.nodeType){o(t,h++);let e=i.get(t.id);if(e)i.delete(t.id);else{const s=r.get(t.tagName);s?.length&&(e=s.shift())}l(e?d(e,t):t)}}),[n,...i.values(),...[...r.values()].flat()].flat().forEach(e=>{e?.parentNode===t&&e.remove()})},d=(t,e)=>t.tagName!==e.tagName?(t.replaceWith(e),e):([a,h,l,c].forEach(s=>s(t,e)),t),f=e.map((e,s)=>{const i=o(e,s),a=n.get(i);a&&n.delete(i);const h=a?d(a,e):t.appendChild(e);return r.add(h.id),h});s.forEach(t=>{r.has(t.id)||t.remove()});let u=null;for(const e of f)e.parentNode&&((u?u.nextElementSibling!==e:t.firstElementChild!==e)&&t.insertBefore(e,u?.nextElementSibling||t.firstElementChild),u=e)}}return customElements.define(t,o),o}
