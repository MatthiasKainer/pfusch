const t="string",e="object";function s(e){try{return e&&typeof e===t?JSON.parse(e):e}catch(t){return e}}const n=t=>JSON.stringify(t),i=(e,...s)=>typeof e===t?e:e.reduce(((t,e,n)=>t+e+(s[n]||"")),"");export function css(t,...e){return{type:"style",content:()=>{var s=new CSSStyleSheet;return s.replaceSync(i(t,...e)),s}}}export const script=t=>({type:"script",content:t});const r=t=>([s,i])=>{parseInt(s,10)!=s&&("function"==typeof i?(t._re??=[],t._re.indexOf(s)<0&&(t.addEventListener(s,i),t._re.push(s))):typeof i===e&&t.state?t.state[s]=i:t.setAttribute(s,typeof i===e?n(i):i))},o=(t,e)=>{t.id=e,r(t)(["id",e])};class a{element=null;state={};constructor(t,...s){if(this.element=document.createElement(t),s){this.state=s[0];for(let t=0;t<s.length;t++){let n=s[t];if(Array.isArray(n)||typeof n===e){if(n&&Array.isArray(n)&&n.raw){this.element.innerHTML=i(n,...s.slice(t+1));break}n&&n instanceof a?this.element.appendChild(n.element):n&&typeof n===e&&Object.entries(n).forEach(r(this.element))}else this.element.innerHTML=n}}}}export const html=new Proxy({},{get:(t,e)=>(...t)=>new a(e,...t)});export function pfusch(t,i,c){c||(c=i,i={}),i={id:"",...i};class h extends HTMLElement{fullRerender=!0;elements=[];is={...i};constructor(){super();this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=this.innerHTML,this.state=(t=>{const e={},s=new Proxy({...this.is},{set:function(s,n,i){return s[n]!==i&&(s[n]=i,"subscribe"!=n&&t(),(e[n]||[]).forEach((t=>t(i)))),!0},get:(t,e)=>t[e]});return s.subscribe=function(t,s){e[t]=e[t]||[],e[t].push(s)},s})((()=>this.render())),Object.keys(this.is).forEach((t=>{this.hasAttribute(t)&&(this.is[t]=s(this.getAttribute(t)),this.state[t]=this.is[t])})),this.render()}static get observedAttributes(){return["id",...Object.entries(i).filter((([t,s])=>typeof s!==e)).map((([t])=>t))]}attributeChangedCallback(t,e,n){e!==n&&(this.state[t]=s(n))}triggerEvent(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))}render(){const t=c(this.state,this.triggerEvent.bind(this)).filter(Boolean),e=[...t.filter((t=>"style"===t.type)),css`${window.document.getElementById("pfusch-style")?.innerText||""}`],s=t.filter((t=>t instanceof a)),i=t.filter((t=>"script"===t.type));if(this.shadowRoot.adoptedStyleSheets=e.map((t=>t.content())),this.fullRerender&&(this.fullRerender=!1,i.forEach((t=>t.content(this))),[...document.querySelectorAll("link[data-pfusch]")].map((t=>this.shadowRoot.append(t.cloneNode(!0))))),"lazy"===this.is.as&&n(this.state)===n(this.is))return;const h=(t,e)=>{const s=t.tagName.toLowerCase();this.shadowRoot.querySelectorAll(s).forEach(((t,n)=>{t.index=n,o(t,t.id||`${s}-${n}`),Object.entries(e).forEach(r(t)),e.apply?.(t,n)}))};s.slice().reverse().forEach(((t,e)=>{const{element:n,state:i}=t;if("interactive"!==n.getAttribute("as")){const t=this.shadowRoot.getElementById(n.id);t&&(t.parentNode.replaceChild(n,t),s.splice(s.length-1-e,1))}else h(n,i),s.splice(s.length-1-e,1)}));const l=Array.from(this.shadowRoot.children);s.forEach(((t,e)=>{const s=t.element;o(s,s.id||`${s.tagName.toLowerCase()}-${e}`);const n=l.find((t=>t.id===s.id));n?n.isEqualNode(s)||this.shadowRoot.replaceChild(s,n):this.shadowRoot.appendChild(s)}))}}return customElements.define(t,h),h}
