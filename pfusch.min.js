const t="string",e="object",s=e=>{try{return e&&typeof e===t?JSON.parse(e):e}catch{return e}},r=JSON.stringify,n=(e,...s)=>typeof e===t?e:e.reduce((t,e,r)=>t+e+(s[r]||""),"");export const css=(t,...e)=>({type:"style",content:()=>{const s=new CSSStyleSheet;return s.replaceSync(n(t,...e)),s}});export const script=t=>({type:"script",content:t});export const toElem=t=>t instanceof i?t:t instanceof HTMLElement?{element:t}:3===t.nodeType?t.textContent:t;class i{constructor(t,...e){this.element=document.createElement(t),this.state=e[0]||{},e.forEach((t,s)=>this.add(t,()=>e.slice(s+1))),this.element.id||=`${t.toLowerCase()}-${Math.random().toString(36).substring(2,8)}`}add(t,s=()=>[]){if(!t)return this;const i=typeof t;var o;return"string"===i?this.element.appendChild(document.createTextNode(t)):Array.isArray(t)?t.forEach(t=>this.add(t,s)):t.raw?this.element.innerHTML=n(t,...s()):t.element||t instanceof HTMLElement?this.element.appendChild(t.element||t):i===e&&Object.entries(t).forEach((o=this.element,([t,s])=>{+t!=t&&("function"==typeof s?(o._re??=[],o._re.indexOf(t)<0&&(o.addEventListener(t,s),o._re.push(t))):typeof s===e&&o.state?o.state[t]=s:t in o?o[t]=s:o.setAttribute(t,typeof s===e?r(s):s))})),this}}export const html=new Proxy({},{get:(t,s)=>(...t)=>{if(t[0]?.raw)return new i(s,n(t[0],...t.slice(1)));if(s.includes("-")||customElements.get(s)){const n=document.createElement(s),[i,...o]=t[0]&&typeof t[0]===e&&!Array.isArray(t[0])?t:[{},...t];return Object.entries(i).forEach(([t,s])=>n["function"==typeof s?"addEventListener":"setAttribute"](t,typeof s===e?r(s):s)),o.forEach(t=>n.appendChild("string"==typeof t?document.createTextNode(t):t?.element||t)),{element:n}}return new i(s,...t)}});export function pfusch(t,e,n){n||([n,e]=[e,{}]);class o extends HTMLElement{static formAssociated=!0;static observedAttributes=["id","as",...Object.keys(e).flatMap(t=>[t,t.toLowerCase()])];constructor(){super(),this.#t=this.attachInternals(),this.scriptsExecuted=!1,this.subscribers={},this.is={...e};for(const[t,r]of Object.entries(e)){const e=this.getAttribute(t)||this.getAttribute(t.toLowerCase());null!==e&&(this.is[t]=s(e))}this.lightDOMChildren=Array.from(this.children),this.attachShadow({mode:"open",serializable:!0}),this.state=new Proxy({...this.is},{set:(t,e,s)=>(t[e]!==s&&(t[e]=s,"subscribe"!==e&&(this.render(),this.#t.setFormValue(r(t))),(this.subscribers[e]||[]).forEach(t=>t(s))),!0),get:(t,e)=>"subscribe"===e?(t,e)=>(this.subscribers[t]??=[]).push(e):t[e]}),"lazy"===this.getAttribute("as")&&this.shadowRoot.children.length||this.render()}#t;attributeChangedCallback(t,e,r){if(e===r)return;if("as"===t&&"lazy"!==r&&"lazy"===e)return this.render();const n=Object.keys(this.is).find(e=>e===t||e.toLowerCase()===t);n&&this.state&&(this.state[n]=s(r))}render(){if(!n)return;const e=t=>t?this.lightDOMChildren.filter(e=>e.tagName?.toLowerCase()===t.toLowerCase()||e.matches?.(t)):this.lightDOMChildren,s=n(this.state,(e,s)=>{const n=`${t}.${e}`;this.dispatchEvent(new CustomEvent(n,{detail:s,bubbles:!0})),this.dispatchEvent(new CustomEvent(e,{detail:s,bubbles:!0})),window.postMessage({eventName:n,detail:{sourceId:this.is.id,data:r(s)}},"*")},{children:e,childElements:t=>e(t).map(toElem)});if(!Array.isArray(s))return;const i=this.shadowRoot.activeElement,o=i?.id,a=[...this.shadowRoot.adoptedStyleSheets];this.shadowRoot.innerHTML="",this.shadowRoot.adoptedStyleSheets=[];const h=document.getElementById("pfusch-style");h&&0===a.length&&a.unshift(this.createSheet(h)),this.shadowRoot.adoptedStyleSheets=a,document.querySelectorAll("link[data-pfusch]").forEach(t=>this.shadowRoot.appendChild(t.cloneNode(!0))),this.renderItems(s),o&&requestAnimationFrame(()=>this.shadowRoot.getElementById(o)?.focus())}renderItems(t){(Array.isArray(t)?t:[t]).forEach(t=>{if(t)if("style"===t.type)this.shadowRoot.adoptedStyleSheets=[...this.shadowRoot.adoptedStyleSheets,t.content()];else if("script"!==t.type||this.scriptsExecuted)t?.element||t instanceof i?this.shadowRoot.appendChild(t.element||t):Array.isArray(t)?this.renderItems(t):"string"==typeof t&&this.shadowRoot.appendChild(document.createTextNode(t));else{try{t.content.call({component:this,shadowRoot:this.shadowRoot,state:this.state,addEventListener:this.addEventListener.bind(this),querySelector:t=>this.shadowRoot.querySelector(t),querySelectorAll:t=>this.shadowRoot.querySelectorAll(t)})}catch(t){console.error("Script execution error:",t)}this.scriptsExecuted=!0}})}createSheet(t){const e=new CSSStyleSheet;return e.replaceSync(t.textContent||t.innerHTML),e}}return customElements.define(t,o),o}
