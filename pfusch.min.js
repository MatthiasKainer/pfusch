const t="string",e="object";function s(e){try{return e&&typeof e===t?JSON.parse(e):e}catch(t){return e}}const i=t=>JSON.stringify(t),n=(e,...s)=>typeof e===t?e:e.reduce((t,e,i)=>t+e+(s[i]||""),"");export function css(t,...e){return{type:"style",content:()=>{const s=new CSSStyleSheet;return s.replaceSync(n(t,...e)),s}}}export const script=t=>({type:"script",content:t});const o=t=>([s,n])=>{parseInt(s,10)!=s&&("function"==typeof n?(t._re??=[],t._re.indexOf(s)<0&&(t.addEventListener(s,n),t._re.push(s))):typeof n===e&&t.state?t.state[s]=n:t.setAttribute(s,typeof n===e?i(n):n))};export const toElem=t=>t instanceof r?t:t instanceof HTMLElement?html[t.tagName]([...t.attributes].reduce((t,e)=>(t[e.name]=e.value,t),{}),...[...t.childNodes].map(toElem)):3===t.nodeType?t.textContent:t;class r{element=null;state={};add(t,s=()=>[]){return Array.isArray(t)||typeof t===e?t?.raw?this.element.innerHTML=n(t,...s()):t instanceof HTMLElement?this.element.appendChild(t):t instanceof r?this.element.appendChild(t.element):t&&typeof t===e&&Object.entries(t).forEach(o(this.element)):this.element.appendChild(document.createTextNode(t)),this}constructor(t,...e){this.element=document.createElement(t),e.length&&(this.state=e[0],e.forEach((t,s)=>this.add(t,()=>e.slice(s+1))))}}export const html=new Proxy({},{get:(t,e)=>(...t)=>new r(e,...t)});export function pfusch(t,n,a){a||(a=n,n={}),n={...n};class c extends HTMLElement{fullRerender=!0;is={...n};static formAssociated=!0;#t;constructor(){super(),this.#t=this.attachInternals();const e=this.#t;this.attachShadow({mode:"open",serializable:!0}),this.state=(t=>{const s={},n=new Proxy({...this.is},{set:(n,o,r)=>(n[o]!==r&&(n[o]=r,"subscribe"!==o&&(t(),e.setFormValue(i(n))),(s[o]||[]).forEach(t=>t(r))),!0),get:(t,e)=>t[e]});return n.subscribe=(t,e)=>{(s[t]??=[]).push(e)},n})(()=>this.render()),this.is.id&&""!==this.is.id||(this.is.id=`${t}-${Math.random().toString(36).substring(7)}`),Object.keys(this.is).forEach(t=>{const e=this.getAttribute(t)||this.getAttribute(t.toLowerCase());null!==e&&(this.is[t]=s(e),this.state[t]=this.is[t])}),"slotted"!==this.is.as&&(this.shadowRoot.innerHTML=this.innerHTML),this.render()}static get observedAttributes(){return["id",...Object.entries(n).filter(([t,s])=>typeof s!==e).map(([t])=>t).flatMap(t=>[t,t.toLowerCase()])]}setElementId(t,e){t.id=e,o(t)(["id",e])}attributeChangedCallback(t,e,i){if(e===i)return;const n=Object.keys(this.is).find(e=>e===t||e.toLowerCase()===t);n&&(this.state[n]=s(i))}triggerEvent(e,s){this.dispatchEvent(new CustomEvent(e,{detail:s,bubbles:!0})),window.postMessage({eventName:`${t}.${e}`,detail:{sourceId:this.is.id,data:i(s)}},"*")}render(){const t=a(this.state,this.triggerEvent.bind(this),[...this.childNodes]).filter(Boolean),e=[...t.filter(t=>"style"===t.type),css`${document.getElementById("pfusch-style")?.innerText||""}`],s=t.filter(t=>t instanceof r),n=t.filter(t=>"script"===t.type);if(this.shadowRoot.adoptedStyleSheets=e.map(t=>t.content()),this.fullRerender){if(this.fullRerender=!1,n.forEach(t=>t.content(this)),location.search.includes("ssr=true")){const t=document.createElement("style");t.innerText=e.map(t=>[...t.content().cssRules].map(t=>t.cssText).join(" ")).join(""),this.shadowRoot.append(t)}[...document.querySelectorAll("link[data-pfusch]")].forEach(t=>this.shadowRoot.append(t.cloneNode(!0)))}if("lazy"===this.is.as&&i(this.state)===i(this.is))return;const c=(t,e)=>{const s=t.tagName.toLowerCase();this.shadowRoot.querySelectorAll(s).forEach((t,i)=>{t.index=i,this.setElementId(t,t.id||`${this.id}.${s}-${i}`),Object.entries(e).forEach(o(t)),e.apply?.(t,i)})};s.slice().reverse().forEach((t,e)=>{const{element:i,state:n}=t;if("interactive"!==i.getAttribute("as")){const t=this.shadowRoot.getElementById(i.id);t&&(t.parentNode.replaceChild(i,t),s.splice(s.length-1-e,1)),i.id||this.setElementId(i,`${i.tagName.toLowerCase()}-${e}`)}else c(i,n),s.splice(s.length-1-e,1)});const h=Array.from(this.shadowRoot.children);s.forEach(t=>{const e=t.element,s=h.find(t=>t.id===e.id);s?s.isEqualNode(e)||this.shadowRoot.replaceChild(e,s):this.shadowRoot.appendChild(e)})}}return customElements.define(t,c),c}
