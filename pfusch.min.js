const t="string",e="object",s=e=>{try{return e&&typeof e===t?JSON.parse(e):e}catch{return e}},i=JSON.stringify,n=(e,...s)=>typeof e===t?e:e.reduce((t,e,i)=>t+e+(s[i]||""),"");export const css=(t,...e)=>({type:"style",content:()=>{const s=new CSSStyleSheet;return s.replaceSync(n(t,...e)),s}});export const script=t=>({type:"script",content:t});export const toElem=t=>t instanceof r?t:t instanceof HTMLElement?{element:t}:3===t.nodeType?t.textContent:t;class r{constructor(t,...e){this.element=document.createElement(t),this.state=e[0]||{},e.forEach((t,s)=>this.add(t,()=>e.slice(s+1)))}add(t,s=()=>[]){if(!t)return this;const r=typeof t;var o;return"string"===r?this.element.appendChild(document.createTextNode(t)):Array.isArray(t)?t.forEach(t=>this.add(t,s)):t.raw?this.element.innerHTML=n(t,...s()):t.element||t instanceof HTMLElement?this.element.appendChild(t.element||t):r===e&&Object.entries(t).forEach((o=this.element,([t,s])=>{+t!=t&&("function"==typeof s?(o._re??=[],o._re.indexOf(t)<0&&(o.addEventListener(t,s),o._re.push(t))):typeof s===e&&o.state?o.state[t]=s:t in o?o[t]=s:o.setAttribute(t,typeof s===e?i(s):s))})),this}}export const html=new Proxy({},{get:(t,s)=>(...t)=>{if(t[0]?.raw)return new r(s,n(t[0],...t.slice(1)));if(s.includes("-")||customElements.get(s)){const n=document.createElement(s),[r,...o]=t[0]&&typeof t[0]===e&&!Array.isArray(t[0])?t:[{},...t];return Object.entries(r).forEach(([t,s])=>n["function"==typeof s?"addEventListener":"setAttribute"](t,typeof s===e?i(s):s)),o.forEach(t=>n.appendChild("string"==typeof t?document.createTextNode(t):t?.element||t)),{element:n}}return new r(s,...t)}});export function pfusch(t,e,n){n||([n,e]=[e,{}]);class o extends HTMLElement{static formAssociated=!0;static observedAttributes=["id","as",...Object.keys(e).flatMap(t=>[t,t.toLowerCase()])];constructor(){super(),this.#t=this.attachInternals(),this._f=32,this._subs={},this._ids=new Map,this.is={...e};for(const[t,i]of Object.entries(e)){const e=this.getAttribute(t)||this.getAttribute(t.toLowerCase());null!==e&&(this.is[t]=s(e))}this.lightDOMChildren=Array.from(this.children),this.attachShadow({mode:"open",serializable:!0}),this.state=new Proxy({...this.is},{set:(t,e,s)=>(t[e]!==s&&(t[e]=s,"subscribe"===e||32&this._f||(this.scheduleRender(),this.#t.setFormValue(i(t))),(this._subs[e]||[]).forEach(t=>t(s))),!0),get:(t,e)=>"subscribe"===e?(e,s)=>{(this._subs[e]??=[]).push(s);try{s(t[e])}catch{}return()=>{const t=this._subs[e];t&&(this._subs[e]=t.filter(t=>t!==s))}}:t[e]})}connectedCallback(){32&this._f&&(this._f&=-33,"lazy"===this.getAttribute("as")&&this.shadowRoot.children.length||this.render())}disconnectedCallback(){this.dispatchEvent(new CustomEvent("disconnected",{bubbles:!1}))}#t;getStableId(t,e){const s=`${t}-${e}`;return this._ids.has(s)||this._ids.set(s,`${t.toLowerCase()}-${Math.random().toString(36).substring(2,8)}`),this._ids.get(s)}attributeChangedCallback(t,e,i){if(e===i)return;if("as"===t&&"lazy"!==i&&"lazy"===e)return this.render();const n=Object.keys(this.is).find(e=>e===t||e.toLowerCase()===t);n&&this.state&&(this.state[n]=s(i))}render(){if(!n)return;if(8&this._f)return void(this._f|=16);this._f|=8;const e=t=>t?this.lightDOMChildren.filter(e=>e.tagName?.toLowerCase()===t.toLowerCase()||e.matches?.(t)):this.lightDOMChildren,s=n(this.state,(e,s)=>{const n=`${t}.${e}`;this.dispatchEvent(new CustomEvent(n,{detail:s,bubbles:!0})),this.dispatchEvent(new CustomEvent(e,{detail:s,bubbles:!0})),window.postMessage({eventName:n,detail:{sourceId:this.is.id,data:i(s)}},"*")},{children:e,childElements:t=>e(t).map(toElem)});if(!Array.isArray(s))return;const o=this.shadowRoot.activeElement,a=o?.id;if(!(2&this._f)){const t=document.getElementById("pfusch-style");if(t){const e=new CSSStyleSheet;e.replaceSync(t.textContent||t.innerHTML),this.shadowRoot.adoptedStyleSheets=[e,...this.shadowRoot.adoptedStyleSheets]}this._f|=2}4&this._f||(document.querySelectorAll("link[data-pfusch]").forEach(t=>this.shadowRoot.appendChild(t.cloneNode(!0))),this._f|=4);const h=[];this._pos=0,s.forEach(t=>{if(t)if("style"===t.type){const e=t.content();this.shadowRoot.adoptedStyleSheets.includes(e)||(this.shadowRoot.adoptedStyleSheets=[...this.shadowRoot.adoptedStyleSheets,e])}else if("script"===t.type){if(!(1&this._f)){try{t.content.call({component:this,shadowRoot:this.shadowRoot,state:this.state,addEventListener:this.addEventListener.bind(this),querySelector:t=>this.shadowRoot.querySelector(t),querySelectorAll:t=>this.shadowRoot.querySelectorAll(t)})}catch(t){console.error("Script execution error:",t)}this._f|=1}}else{const e=t=>{t.id||(t.id=this.getStableId(t.tagName,this._pos++)),h.push(t)};if(Array.isArray(t))t.forEach(t=>{if(t)if(t?.element||t instanceof r)e(t.element||t);else if("string"==typeof t){const s=document.createElement("span");s.textContent=t,e(s)}});else if(t?.element||t instanceof r)e(t.element||t);else if("string"==typeof t){const s=document.createElement("span");s.textContent=t,e(s)}}}),this.syncChildren(this.shadowRoot,h.filter(t=>"LINK"!==t.tagName)),a&&requestAnimationFrame(()=>this.shadowRoot.getElementById(a)?.focus()),this._f&=-9,64&this._f&&(this._f&=-65),16&this._f&&(this._f&=-17,this.render())}scheduleRender(){8&this._f?this._f|=16:64&this._f||(this._f|=64,queueMicrotask(()=>{64&this._f&&(8&this._f?this._f|=16:this.render())}))}syncChildren(t,e){const s=Array.from(t.children).filter(t=>null===t.getAttribute("data-pfusch")),i=new Map(s.map(t=>[t.id,t])),n=new Set,r=["checked","selected","disabled","readonly","multiple"],o=(t,e)=>{if(t.tagName!==e.tagName)return void t.replaceWith(e);for(const s of e.attributes)t.getAttribute(s.name)!==s.value&&t.setAttribute(s.name,s.value);for(const s of Array.from(t.attributes))"id"===s.name||e.hasAttribute(s.name)||t.removeAttribute(s.name);for(const s of r)if(void 0!==e[s]&&e[s]!==t[s])try{t[s]=e[s]}catch{}if("value"in e){const s=/^(INPUT|TEXTAREA|SELECT)$/.test(e.tagName),i=e.hasAttribute&&e.hasAttribute("value"),n=document.activeElement===t||t.contains(document.activeElement);if((i||!s)&&e.value!==t.value&&!n)try{t.value=e.value}catch{}}const s=Array.from(t.children),i=Array.from(e.children);i.length||s.length?(i.forEach((e,i)=>{let n=s[i];e.id||(e.id=n?.id||this.getStableId(e.tagName,i)),n?o(n,e):t.appendChild(e)}),s.length>i.length&&s.slice(i.length).forEach(t=>t.remove())):t.textContent!==e.textContent&&(t.textContent=e.textContent)};e.forEach(e=>{const s=e.id&&i.get(e.id);s?(o(s,e),n.add(s.id)):(t.appendChild(e),n.add(e.id))}),s.forEach(t=>{n.has(t.id)||t.remove()});let a=null;e.forEach(e=>{const s=e.id&&i.get(e.id)||e;s.parentNode&&(a?a.nextElementSibling!==s&&t.insertBefore(s,a.nextElementSibling):t.firstElementChild!==s&&t.insertBefore(s,t.firstElementChild),a=s)})}}return customElements.define(t,o),o}
