const t="string",e="object";function s(e){try{return e&&typeof e===t?JSON.parse(e):e}catch(t){return e}}const i=t=>JSON.stringify(t),n=(e,...s)=>typeof e===t?e:e.reduce(((t,e,i)=>t+e+(s[i]||"")),"");export function css(t,...e){return{type:"style",content:()=>{var s=new CSSStyleSheet;return s.replaceSync(n(t,...e)),s}}}export const script=t=>({type:"script",content:t});const r=t=>([s,n])=>{parseInt(s,10)!=s&&("function"==typeof n?(t._re??=[],t._re.indexOf(s)<0&&(t.addEventListener(s,n),t._re.push(s))):typeof n===e&&t.state?t.state[s]=n:t.setAttribute(s,typeof n===e?i(n):n))},o=(t,e)=>{t.id=e,r(t)(["id",e])};class a{element=null;state={};constructor(t,...s){if(this.element=document.createElement(t),s){this.state=s[0];for(let t=0;t<s.length;t++){let i=s[t];if(Array.isArray(i)||typeof i===e){if(i&&Array.isArray(i)&&i.raw){this.element.innerHTML=n(i,...s.slice(t+1));break}i&&i instanceof a?this.element.appendChild(i.element):i&&typeof i===e&&Object.entries(i).forEach(r(this.element))}else this.element.innerHTML=i}}}}export const html=new Proxy({},{get:(t,e)=>(...t)=>new a(e,...t)});export function pfusch(t,n,c){c||(c=n,n={}),n={id:"",...n};class h extends HTMLElement{fullRerender=!0;elements=[];is={...n};constructor(){super();this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=this.innerHTML,this.state=(t=>new Proxy({...this.is},{set:function(e,s,i){return e[s]!==i&&(e[s]=i,t()),!0},get:(t,e)=>t[e]}))((()=>this.render())),Object.keys(this.is).forEach((t=>{this.hasAttribute(t)&&(this.is[t]=s(this.getAttribute(t)),this.state[t]=this.is[t])})),this.render()}static get observedAttributes(){return["id",...Object.entries(n).filter((([t,s])=>typeof s!==e)).map((([t])=>t))]}attributeChangedCallback(t,e,i){e!==i&&(this.state[t]=s(i))}triggerEvent(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))}render(){const t=c(this.state,this.triggerEvent.bind(this)).filter(Boolean),e=[...t.filter((t=>"style"===t.type)),css`${window.document.getElementById("pfusch-style")?.innerText||""}`],s=t.filter((t=>t instanceof a)),n=t.filter((t=>"script"===t.type));if(this.shadowRoot.adoptedStyleSheets=e.map((t=>t.content())),this.fullRerender&&(this.fullRerender=!1,n.forEach((t=>t.content(this)))),"lazy"===this.is.as&&i(this.state)===i(this.is))return;const h=(t,e)=>{const s=t.tagName.toLowerCase();this.shadowRoot.querySelectorAll(s).forEach(((t,i)=>{t.index=i,o(t,t.id||`${s}-${i}`),Object.entries(e).forEach(r(t)),e.apply?.(t,i)}))};s.slice().reverse().forEach(((t,e)=>{const{element:i,state:n}=t;if("interactive"!==i.getAttribute("as")){const t=this.shadowRoot.getElementById(i.id);t&&(t.parentNode.replaceChild(i,t),s.splice(s.length-1-e,1))}else h(i,n),s.splice(s.length-1-e,1)}));const l=Array.from(this.shadowRoot.children);s.forEach(((t,e)=>{const s=t.element;o(s,s.id||`${s.tagName.toLowerCase()}-${e}`);const i=l.find((t=>t.id===s.id));i?i.isEqualNode(s)||this.shadowRoot.replaceChild(s,i):this.shadowRoot.appendChild(s)}))}}return customElements.define(t,h),h}
