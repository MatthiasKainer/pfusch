const t="string",e="object";function s(e){try{return e&&typeof e===t?JSON.parse(e):e}catch(t){return e}}const i=t=>JSON.stringify(t),n=(e,...s)=>typeof e===t?e:e.reduce(((t,e,i)=>t+e+(s[i]||"")),"");export function css(t,...e){return{type:"style",content:()=>{var s=new CSSStyleSheet;return s.replaceSync(n(t,...e)),s}}}export const script=t=>({type:"script",content:t});const r=t=>([s,n])=>{parseInt(s,10)!=s&&("function"==typeof n?(t._re??=[],t._re.indexOf(s)<0&&(t.addEventListener(s,n),t._re.push(s))):typeof n===e&&t.state?t.state[s]=n:t.setAttribute(s,typeof n===e?i(n):n))};class o{element=null;state={};constructor(t,...s){if(this.element=document.createElement(t),s){this.state=s[0];for(let t=0;t<s.length;t++){let i=s[t];if(Array.isArray(i)||typeof i===e){if(i&&Array.isArray(i)&&i.raw){this.element.innerHTML=n(i,...s.slice(t+1));break}i&&i instanceof o?this.element.appendChild(i.element):i&&typeof i===e&&Object.entries(i).forEach(r(this.element))}else this.element.innerHTML=i}}}}export const html=new Proxy({},{get:(t,e)=>(...t)=>new o(e,...t)});export function pfusch(t,n,a){a||(a=n,n={}),n={...n};class c extends HTMLElement{fullRerender=!0;elements=[];is={...n};static formAssociated=!0;#t;constructor(){super(),this.#t=this.attachInternals();const e=this.#t;this.attachShadow({mode:"open",serializable:!0}),this.state=(t=>{const s={},n=new Proxy({...this.is},{set:function(n,r,o){return n[r]!==o&&(n[r]=o,"subscribe"!=r&&(t(),e.setFormValue(i(n))),(s[r]||[]).forEach((t=>t(o)))),!0},get:(t,e)=>t[e]});return n.subscribe=function(t,e){s[t]=s[t]||[],s[t].push(e)},n})((()=>this.render())),this.is.id&&""!==this.is.id||(this.is.id=`${t}-${Math.random().toString(36).substring(7)}`),Object.keys(this.is).forEach((t=>{this.hasAttribute(t)&&(this.is[t]=s(this.getAttribute(t)),this.state[t]=this.is[t])})),"slotted"!==this.is.as&&(this.shadowRoot.innerHTML=this.innerHTML),this.render()}static get observedAttributes(){return["id",...Object.entries(n).filter((([t,s])=>typeof s!==e)).map((([t])=>t))]}setElementId(t,e){t.id=e,r(t)(["id",e])}attributeChangedCallback(t,e,i){e!==i&&(this.state[t]=s(i))}triggerEvent(e,s){this.dispatchEvent(new CustomEvent(e,{detail:s,bubbles:!0})),window.postMessage({eventName:`${t}.${e}`,detail:{sourceId:this.is.id,data:i(s)}},"*")}render(){const t=a(this.state,this.triggerEvent.bind(this)).filter(Boolean),e=[...t.filter((t=>"style"===t.type)),css`${window.document.getElementById("pfusch-style")?.innerText||""}`],s=t.filter((t=>t instanceof o)),n=t.filter((t=>"script"===t.type));if(this.shadowRoot.adoptedStyleSheets=e.map((t=>t.content())),this.fullRerender){if(this.fullRerender=!1,n.forEach((t=>t.content(this))),window.location.search.includes("ssr=true")){const t=document.createElement("style");t.innerText=e.map((t=>[...t.content().cssRules].map((t=>t.cssText)).join(" "))).join(""),this.shadowRoot.append(t)}[...document.querySelectorAll("link[data-pfusch]")].map((t=>this.shadowRoot.append(t.cloneNode(!0))))}if("lazy"===this.is.as&&i(this.state)===i(this.is))return;const c=(t,e)=>{const s=t.tagName.toLowerCase();this.shadowRoot.querySelectorAll(s).forEach(((t,i)=>{t.index=i,this.setElementId(t,t.id||`${this.id}.${s}-${i}`),Object.entries(e).forEach(r(t)),e.apply?.(t,i)}))};s.slice().reverse().forEach(((t,e)=>{const{element:i,state:n}=t;if("interactive"!==i.getAttribute("as")){const t=this.shadowRoot.getElementById(i.id);t&&(t.parentNode.replaceChild(i,t),s.splice(s.length-1-e,1)),i.id&&""!==i.id||this.setElementId(i,`${i.tagName.toLowerCase()}-${e}`)}else c(i,n),s.splice(s.length-1-e,1)}));const h=Array.from(this.shadowRoot.children);s.forEach(((t,e)=>{const s=t.element,i=h.find((t=>t.id===s.id));i?i.isEqualNode(s)||this.shadowRoot.replaceChild(s,i):this.shadowRoot.appendChild(s)}))}}return customElements.define(t,c),c}
